---
title: "network_plot_work"
author: "Fred White"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggrepel)
library(readxl)
library(extrafont)
library(cowplot)
library(graphlayouts)
library(gganimate)
library(animation)
```

```{r}
# font_import() # download once 
#windowsFonts() # to check which are loaded
```

```{r}
loadfonts(device = "win", quiet = TRUE)

###partial correlations

library(ppcor)
library(psych)

#
# plot residuals and full (with tweaks for problem demonstration)

baits <- c(baits,spikes[1:5])
spikes <- spikes[-c(1:5)]

residuals <- ar[[3]]
data <- sim_data[[1]]


cand_vals <- residuals[,1970:2000]    #rgs[which(rownames(rgs) %in% names(g_b)[1:50]),]


adj <- cor(cand_vals)

rownames(adj) <- colnames(cand_vals)
colnames(adj) <- colnames(cand_vals)


```

```{r}
set.seed(12)
pways <- sum(length(baits),length(spikes))
W <- matrix(sample(c(0,0,0,0,1),pways*pways, replace = T), nrow = pways)

adj[which(rownames(adj) %in% c(baits,spikes)),which(colnames(adj) %in% c(baits,spikes))] <- adj[which(rownames(adj) %in% c(baits,spikes)),which(colnames(adj) %in% c(baits,spikes))] * W

```


```{r}
set.seed(345)
W <- matrix(sample(c(1,0,0,0,0),15*15, replace = T), nrow = 15)
adj[-which(rownames(adj) %in% c(baits,spikes)),-which(colnames(adj) %in% c(baits,spikes))]  <- 0.9

adj[-which(rownames(adj) %in% c(baits,spikes)),-which(colnames(adj) %in% c(baits,spikes))] <- adj[-which(rownames(adj) %in% c(baits,spikes)),-which(colnames(adj) %in% c(baits,spikes))] * W

```

```{r}
#randomly sparsify p1 p2 connections 

set.seed(22)


W <- matrix(sample(c(1,0,0,0,0),length(baits) * length(spikes), replace = T), nrow = length(spikes))


adj[which(rownames(adj) %in% spikes),which(colnames(adj) %in% baits)] <- adj[which(rownames(adj) %in% spikes),which(colnames(adj) %in% baits)] * W


```


```{r}
library(igraph)

g <- graph.adjacency(
  as.matrix(as.dist(adj)),
  mode="undirected",
  weighted=TRUE,
  diag=FALSE
)

g <- simplify(g, remove.multiple=TRUE, remove.loops=FALSE)

E(g)[which(E(g)$weight<0)]$association <- "-ve"
E(g)[which(E(g)$weight>0)]$association <- "+ve"

# Convert edge weights to absolute values
E(g)$weight <- abs(E(g)$weight)
```

```{r}
###
g <- delete_edges(g, E(g)[which(E(g)$weight<0.55)])

# Remove nodes with no edges
g <- delete.vertices(g, degree(g)==0)

V(g)$name <- V(g)$name

```

```{r}

coords <- layout_with_kk(g)  #to fix coordinates of nodes 


```

```{r}

########
library(tidygraph)
library(ggraph)

type <- V(g)$name
```

```{r}
id <- c(1:length(type))


VIP <- rep(5,length(V(g)))


type[which(type %in% baits)] <- "POI"
type[which(type %in% spikes)] <- "RP"

type[-which(type %in% c("POI","RP"))] <- "URP"


tidynet <- as_tbl_graph(g)

tidynet <- tidynet %>%
  activate(nodes) %>%
  mutate(VIP = VIP)

tidynet <- tidynet %>%
  activate(nodes) %>%
  mutate(type = type)


colours = c("POI" = "purple", "RP" = "orange", "URP" = "lightgreen")   

edge_colours <- c("+ve" = "grey", "-ve" = "blue")


realnet <- tidynet



realplot <- ggraph(tidynet, layout = coords) + 
  geom_edge_link(aes(colour = association, alpha = weight), show.legend=FALSE) +  
  scale_edge_color_manual(values = edge_colours, guide = "none") +
  geom_node_point(
    aes(size = VIP, color = type), show.legend=FALSE
  ) +
  geom_node_point(
    aes(color = type)
  ) +
  scale_color_manual(values = colours) + 

  theme_void() 


```


```{r}
#only take nodes and layout from above

#remake graph or replace weights and edges with between group variance added

#remake adj with only names(V(g)) and calculate weights on data not residuals

cand_vals <- data[,which(colnames(data) %in% names(V(g)))]

adj <- cor(cand_vals)

rownames(adj) <- colnames(cand_vals)
colnames(adj) <- colnames(cand_vals)



g <- graph.adjacency(
  as.matrix(as.dist(adj)),
  mode="undirected",
  weighted=TRUE,
  diag=FALSE
)

g <- simplify(g, remove.multiple=TRUE, remove.loops=FALSE)

# Colour negative correlation edges as blue
E(g)[which(E(g)$weight<0)]$association <- "-ve"
# Colour positive correlation edges as red
E(g)[which(E(g)$weight>0)]$association <- "+ve"

# Convert edge weights to absolute values
E(g)$weight <- abs(E(g)$weight)



###
g <- delete_edges(g, E(g)[which(E(g)$weight<0.4)])

g <- delete.vertices(g, degree(g)==0)

V(g)$name <- V(g)$name

V(g)$shape <- "sphere"


#define correctly ordered type type
type <- V(g)$name




```

```{r}
id <- c(1:length(type))


VIP <- rep(5,length(V(g)))

type[which(type %in% baits)] <- "POI"
type[which(type %in% spikes)] <- "RP"

type[-which(type %in% c("POI","RP"))] <- "URP"



tidynet <- as_tbl_graph(g)

tidynet <- tidynet %>%
  activate(nodes) %>%
  mutate(VIP = VIP)

tidynet <- tidynet %>%
  activate(nodes) %>%
  mutate(type = type)


colours = c("POI" = "purple", "RP" = "orange", "URP" = "lightgreen")  

edge_colours <- c("+ve" = "grey", "-ve" = "blue")

badnet <- tidynet

```

```{r}

badplot <- ggraph(tidynet, layout = coords) + 
  geom_edge_link(aes(colour = association, alpha = weight), show.legend=FALSE) + 
  scale_edge_color_manual(values = edge_colours, guide = "none") +
  geom_node_point(
    aes(size = VIP, color = type), show.legend=FALSE
  ) +
  geom_node_point(
    aes(color = type)
  ) +
  scale_color_manual(values = colours) + 
  theme_void() 

  
  
 
```


```{r}

png("networktypes.png", height = 360)
realplot + badplot + plot_annotation("Pathway Types", tag_levels = 'A') + plot_layout(guides = "collect")
dev.off()

```

